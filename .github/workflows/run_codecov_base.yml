---
name: codecov base

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
  pull_request:
    paths:
      - '**/*.c'
      - '**/*.h'
      - 'grammar/lexer.l'
      - 'grammar/grammar.y'
      - 'tests/*.sh'
      - 'diag.sh'
      - '**/Makefile.am'
      - 'configure.ac'
      - '.github/workflows/*.yml'

jobs:
  CI:
    runs-on: ubuntu-24.04
    timeout-minutes: 50

    steps:
      - name: add extra dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            lcov \
            clang-tools \
            curl \
            cmake-curses-gui \
            python3-dev \
            ruby-dev \
            python3-sphinx \
            default-jre-headless \
            faketime \
            libdbd-mysql \
            gdb \
            libaprutil1-dev \
            libbson-dev \
            libcivetweb-dev \
            libcap-ng-dev \
            libcap-ng0 \
            libcurl4-gnutls-dev \
            libdbi-dev \
            libgcrypt20-dev \
            libglib2.0-dev \
            libgnutls28-dev \
            libhiredis-dev \
            libkrb5-dev \
            liblz4-dev \
            libmaxminddb-dev libmongoc-dev \
            libmongoc-dev \
            libmysqlclient-dev \
            libnet1-dev \
            libpcap-dev \
            librabbitmq-dev \
            libsnmp-dev \
            libssl-dev libsasl2-dev libsasl2-2 libsasl2-modules \
            libsystemd-dev \
            libtirpc-dev \
            libtokyocabinet-dev \
            libtool \
            libtool-bin \
            libzstd-dev \
            mysql-server \
            net-tools \
            postgresql-client libpq-dev \
            python3-docutils  \
            python3-pip \
            python3-pysnmp4 \
            software-properties-common \
            uuid-dev \
            valgrind \
            zlib1g-dev \
            libestr-dev \
            libfastjson-dev \
            librdkafka-dev \
            libfastjson-dev \
            librelp-dev \
            liblognorm-dev \
            libczmq-dev \
            tcl-dev \
            libsodium-dev \
            cmake

      - name: add helper projects
        run: |
          mkdir helper-projects
          #git clone https://github.com/apache/qpid-proton.git
          #cd qpid-proton
          #mkdir build
          #cd build
          #cmake .. -DCMAKE_INSTALL_PREFIX=/usr -DSYSINSTALL_BINDINGS=ON \
          #         -DBUILD_TESTING=OFF && \
          #make -j8
          #make install
          #cd ..
          cd ..

      - name: git checkout project
        uses: actions/checkout@v4

      - name: enable coverage flags
        run: |
          echo 'CFLAGS=-g -O0 --coverage -fprofile-update=atomic' >> "$GITHUB_ENV"
          echo 'LDFLAGS=--coverage' >> "$GITHUB_ENV"

      - name: prepare for build
        env:
          CFLAGS: ${{ env.CFLAGS }}
          LDFLAGS: ${{ env.LDFLAGS }}
        run: |
          autoreconf -fvi
          ./configure \
            --enable-compile-warning=error \
            --enable-clickhouse \
            --enable-clickhouse-tests=no \
            --disable-elasticsearch \
            --disable-elasticsearch-tests \
            --disable-ffaup \
            --enable-gnutls \
            --enable-gssapi-krb5 \
            --enable-imbatchreport \
            --enable-imczmq \
            --enable-imdiag \
            --enable-imdocker \
            --disable-imdocker-tests \
            --enable-imfile \
            --enable-imhttp \
            --enable-imjournal \
            --disable-imkafka \
            --disable-omkafka \
            --enable-impstats \
            --enable-impcap \
            --enable-imptcp \
            --disable-kafka-tests \
            --disable-ksi-ls12 \
            --enable-libdbi \
            --enable-libfaketime \
            --enable-libgcrypt \
            --enable-libzstd \
            --enable-mail \
            --enable-mmanon \
            --enable-mmaudit \
            --enable-mmcapture \
            --enable-mmcount \
            --enable-mmdarwin \
            --enable-mmdblookup \
            --enable-mmfields \
            --enable-mmjsonparse \
            --enable-mmkubernetes \
            --enable-mmnormalize \
            --enable-mmpstrucdata \
            --enable-mmrm1stspace \
            --enable-mmsequence \
            --enable-mmsnmptrapd \
            --enable-mmutf8fix \
            --disable-mysql \
            --disable-mysql-tests \
            --disable-omamqp1 \
            --enable-omczmq \
            --enable-omhiredis \
            --enable-omhiredis \
            --enable-omhttpfs \
            --enable-omhttp \
            --enable-omjournal \
            --disable-omkafka \
            --enable-ommongodb \
            --enable-omprog \
            --enable-omrabbitmq \
            --enable-omrelp-default-port=13515 \
            --enable-omruleset \
            --enable-omsendertrack \
            --enable-omstdout \
            --enable-omtcl \
            --enable-omudpspoof \
            --enable-omuxsock \
            --enable-openssl \
            --enable-pgsql \
            --enable-pmaixforwardedfrom \
            --enable-pmciscoios \
            --enable-pmcisconames \
            --enable-pmlastmsg \
            --enable-pmnormalize \
            --enable-pmnull \
            --enable-pmsnare \
            --enable-relp \
            --disable-snmp \
            --disable-snmp-tests \
            --enable-usertools \
            --enable-imdtls \
            --enable-omdtls \
            --enable-mmaitag \
            --enable-valgrind \
            --enable-testbench

      - name: build
        env:
          CFLAGS: ${{ env.CFLAGS }}
          LDFLAGS: ${{ env.LDFLAGS }}
        run: make -j10

      - name: make check
        env:
          CFLAGS: ${{ env.CFLAGS }}
          LDFLAGS: ${{ env.LDFLAGS }}
        run: make -j5 check

      - name: show error logs (if we errored)
        if: ${{ failure() || cancelled() }}
        run: |
          devtools/gather-check-logs.sh
          cat failed-tests.log

      - name: generate coverage (lcov)
        if: ${{ always() }}
        run: |
          # capture; tolerate macro/line-mapping quirks and normalise
          # unexecuted blocks
          lcov --capture --directory . \
               --rc geninfo_unexecuted_blocks=1 \
               --ignore-errors mismatch \
               --output-file coverage.raw.info

          # optional pruning to reduce noise
          lcov --remove coverage.raw.info '/usr/*' '*/tests/*' -o coverage.info || true
          rm -f coverage.raw.info

          # sanity: list summary and ensure file exists (non-empty)
          lcov --list coverage.info | sed -n '1,60p' || true
          [ -s coverage.info ] || { echo "coverage.info is empty"; exit 1; }

      # Push to protected branches -> needs token
      - name: Upload coverage to Codecov (push)
        if: ${{ always() && github.event_name == 'push' }}
        uses: codecov/codecov-action@v4
        with:
          files: coverage.info
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: main
          fail_ci_if_error: false

      # Same-repo PRs: use org/repo secret (protected branches need token)
      - name: Upload coverage to Codecov (internal)
        if: ${{ always() && github.event.pull_request.head.repo.full_name == github.repository }}
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.info
          flags: main
          fail_ci_if_error: false

      # Forked PRs: tokenless upload
      - name: Upload coverage to Codecov (fork PR)
        if: ${{ always() && github.event.pull_request.head.repo.full_name != github.repository }}
        uses: codecov/codecov-action@v4
        with:
          files: coverage.info
          flags: main
          fail_ci_if_error: false

      - name: show error logs (if we errored)
        if: ${{ failure() || cancelled() }}
        run: |
          devtools/gather-check-logs.sh
          cat failed-tests.log
