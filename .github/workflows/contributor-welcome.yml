name: Generate Contributor Welcome Message

on:
  pull_request_target:
    types: [opened]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-info:
    runs-on: ubuntu-latest
    steps:
      - name: Get Contributor Info
        id: contributor_info
        run: |
          set -euo pipefail
          pr_creator="${{ github.event.pull_request.user.login }}"
          repo_owner="${{ github.repository_owner }}"
          repo_name="${{ github.event.repository.name }}"

          # Account creation date
          created_at=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
            "https://api.github.com/users/$pr_creator" | jq -r '.created_at // empty')
          if [ -n "${created_at:-}" ]; then
            created_date=$(date -d "$created_at" '+%s')
            current_date=$(date '+%s')
            account_age_days=$(( (current_date - created_date) / 86400 ))
          else
            account_age_days=0
          fi

          # Count merged PRs by this author in THIS repo
          merged_prs=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
            "https://api.github.com/search/issues?q=repo:$repo_owner/$repo_name+is:pr+is:merged+author:$pr_creator" \
            | jq '.total_count // 0')

          # Public commit count (optional; preview header kept for compatibility)
          total_public_commits=$(curl -s \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github.cloak-preview+json" \
            "https://api.github.com/search/commits?q=author:$pr_creator" \
            | jq '.total_count // 0')

          {
            echo "pr_creator=$pr_creator"
            echo "account_age_days=$account_age_days"
            echo "merged_prs=$merged_prs"
            echo "total_public_commits=$total_public_commits"
          } >> "$GITHUB_OUTPUT"

      - name: Add Public Welcome Message
        id: welcome_message
        uses: actions/github-script@v7
        with:
          script: |
            const pr_creator = '${{ steps.contributor_info.outputs.pr_creator }}';
            const account_age_days = parseInt('${{ steps.contributor_info.outputs.account_age_days }}', 10);
            const merged_prs = parseInt('${{ steps.contributor_info.outputs.merged_prs }}', 10);
            const total_public_commits = parseInt('${{ steps.contributor_info.outputs.total_public_commits }}', 10);

            if (Number.isNaN(merged_prs) || merged_prs >= 30) {
              core.info('Seasoned contributor or unknown count. Skipping welcome.');
              return;
            }

            let welcomeIntro = `ðŸ‘‹ **Welcome, @${pr_creator}!**`;
            if (account_age_days < 30) {
              welcomeIntro += ` Great to see a new developer contributing!`;
            } else if (account_age_days < 365) {
              welcomeIntro += ` Happy to see you growing on GitHub and choosing rsyslog.`;
            } else {
              welcomeIntro += ` Thanks for contributing!`;
            }

            let mainMessage = '';
            if (merged_prs === 0 && total_public_commits === 0) {
              mainMessage = `Thank you for your very first PR on GitHub!`;
            } else if (merged_prs === 0) {
              mainMessage = `Thank you for your first PR with us!`;
            } else if (merged_prs < 10) {
              mainMessage = `This is your ${Intl.NumberFormat('en', { style: 'ordinal' }).format(merged_prs + 1)} PR here. Glad you are sticking with us.`;
            } else {
              mainMessage = `Thank you for your continued contributions!`;
            }

            const policyMessage =
              `\nAll contributions undergo automated and manual review. ` +
              `To help us merge faster, please address tool comments or briefly explain why not.`;

            let generalMessage = '';
            if (!(merged_prs === 0 && total_public_commits === 0)) {
              if (total_public_commits < 10) {
                generalMessage = `\n\nWe appreciate you choosing rsyslog so early in your GitHub journey.`;
              } else if (total_public_commits < 30) {
                generalMessage = `\n\nThanks for adding rsyslog to your contributions.`;
              } else if (total_public_commits < 100) {
                generalMessage = `\n\nContributing here is a solid way to grow your profile.`;
              }
            }

            const body = `${welcomeIntro}\n\n${mainMessage}${policyMessage}${generalMessage}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

