---
name: "Clang Static Analyzer"

'on':
  pull_request: {}

jobs:
  clang-analyzer:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run clang static analyzer
        id: run-clang
        env:
          RSYSLOG_DEV_CONTAINER: rsyslog/rsyslog_dev_base_ubuntu:24.04
          SCAN_BUILD: scan-build
          SCAN_BUILD_CC: clang
          SCAN_BUILD_REPORT_DIR: scan-build-report
          DOCKER_RUN_EXTRA_OPTS: >-
            -e SCAN_BUILD -e SCAN_BUILD_CC -e SCAN_BUILD_REPORT_DIR
        run: |
          chmod -R go+rw .
          set +e
          devtools/devcontainer.sh --rm devtools/run-static-analyzer.sh
          echo "exitcode=$?" >> $GITHUB_OUTPUT

      - name: Upload clang static analyzer report
        if: always()
        id: upload-report
        uses: actions/upload-artifact@v4
        with:
          name: clang-static-analyzer-report
          path: scan-build-report
          retention-days: 7

      - name: Show clang static analyzer report link
        if: always()
        run: |
          url=${{ steps.upload-report.outputs.artifact-url }}
          echo "Clang static analyzer HTML report:" >> $GITHUB_STEP_SUMMARY
          echo "$url" >> $GITHUB_STEP_SUMMARY
          echo "Clang static analyzer HTML report:"
          echo "$url"

      - name: Fail if analysis failed
        if: steps.run-clang.outputs.exitcode != '0'
        run: exit 1
