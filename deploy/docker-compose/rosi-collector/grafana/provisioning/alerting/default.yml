apiVersion: 1

groups:
  - name: missing-logs
    interval: 1m
    orgId: 1
    folder: Alerts
    rules:
      - uid: missing-logs-host
        title: Host stopped sending logs
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: loki
            model:
              expr: 'sum by (host) (count_over_time({job="syslog"} [5m]))'
              refId: A
              queryType: range
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              settings:
                mode: dropNN
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              conditions:
                - evaluator:
                    params:
                      - 1
                      - 0
                    type: lt
                  operator:
                    type: and
                  query:
                    params: []
                  reducer:
                    params: []
                    type: avg
                  type: query
              expression: B
              refId: C
              type: threshold
        noDataState: Alerting
        execErrState: Alerting
        for: 5m
        annotations:
          description: 'Host {{ $labels.host }} has not sent any logs in the last 5 minutes (count: {{ $values.B.Value }})'
          summary: 'Missing logs from {{ $labels.host }}'
        labels:
          alertname: Host stopped sending logs
          severity: warning
          component: logging

  - name: system-resources
    interval: 30s
    orgId: 1
    folder: Alerts
    rules:
      - uid: high-cpu-usage
        title: High CPU usage
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: '100 - (avg by(instance, host) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)'
              refId: A
              queryType: range
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              settings:
                mode: dropNN
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              conditions:
                - evaluator:
                    params:
                      - 80
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params: []
                  reducer:
                    params: []
                    type: avg
                  type: query
              expression: B
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Alerting
        for: 5m
        annotations:
          description: 'CPU usage on {{ $labels.host }} ({{ $labels.instance }}) is above 80% (current: {{ printf "%.1f" $values.B.Value }}%)'
          summary: 'High CPU usage on {{ $labels.host }}'
        labels:
          alertname: High CPU usage
          severity: warning
          component: system

      - uid: high-memory-usage
        title: High memory usage
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'max by(instance, host) ((1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100)'
              refId: A
              queryType: range
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              settings:
                mode: dropNN
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              conditions:
                - evaluator:
                    params:
                      - 85
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params: []
                  reducer:
                    params: []
                    type: avg
                  type: query
              expression: B
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Alerting
        for: 5m
        annotations:
          description: 'Memory usage on {{ $labels.host }} ({{ $labels.instance }}) is above 85% (current: {{ printf "%.1f" $values.B.Value }}%)'
          summary: 'High memory usage on {{ $labels.host }}'
        labels:
          alertname: High memory usage
          severity: warning
          component: system

      - uid: low-disk-space
        title: Low disk space
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'max by(instance, host) ((1 - (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"})) * 100)'
              refId: A
              queryType: range
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              settings:
                mode: dropNN
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              conditions:
                - evaluator:
                    params:
                      - 90
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params: []
                  reducer:
                    params: []
                    type: avg
                  type: query
              expression: B
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Alerting
        for: 5m
        annotations:
          description: 'Disk usage on {{ $labels.host }} ({{ $labels.instance }}) is above 90% (current: {{ printf "%.1f" $values.B.Value }}%)'
          summary: 'Low disk space on {{ $labels.host }}'
        labels:
          alertname: Low disk space
          severity: critical
          component: system

  - name: rsyslog-metrics
    interval: 1m
    orgId: 1
    folder: Alerts
    rules:
      - uid: high-error-rate
        title: High error log rate
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: loki
            model:
              expr: 'sum by (host) (rate({job="syslog", severity=~"error|critical"} [5m]))'
              refId: A
              queryType: range
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              settings:
                mode: dropNN
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              conditions:
                - evaluator:
                    params:
                      - 10
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params: []
                  reducer:
                    params: []
                    type: avg
                  type: query
              expression: B
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Alerting
        for: 5m
        annotations:
          description: 'Error log rate from {{ $labels.host }} is above 10 logs/second (current: {{ printf "%.1f" $values.B.Value }}/s)'
          summary: 'High error rate from {{ $labels.host }}'
        labels:
          alertname: High error log rate
          severity: warning
          component: rsyslog

      - uid: log-volume-anomaly
        title: Log volume anomaly
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 1200
              to: 0
            datasourceUid: loki
            model:
              expr: 'sum by (host) (rate({job="syslog"}[5m])) / sum by (host) (rate({job="syslog"}[15m]))'
              refId: A
              queryType: range
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: B
            relativeTimeRange:
              from: 1200
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              settings:
                mode: dropNN
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 1200
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              conditions:
                - evaluator:
                    params:
                      - 3
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params: []
                  reducer:
                    params: []
                    type: avg
                  type: query
              expression: B
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Alerting
        for: 5m
        annotations:
          description: 'Log volume from {{ $labels.host }} is {{ printf "%.1f" $values.B.Value }}x the 15-minute average rate (threshold: 3x)'
          summary: 'Log volume anomaly from {{ $labels.host }}'
        labels:
          alertname: Log volume anomaly
          severity: info
          component: rsyslog

  # rsyslog impstats alerts. Disabled by default; enable in Grafana UI (Alerting → Alert rules → toggle) after tuning thresholds.
  - name: rsyslog-impstats
    interval: 1m
    orgId: 1
    folder: Alerts
    rules:
      - uid: impstats-queue-depth-high
        title: Rsyslog queue depth high
        isPaused: true
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: '(rsyslog_core_queue_size{job="rsyslog-impstats"} / rsyslog_core_queue_maxqsize{job="rsyslog-impstats"}) unless rsyslog_core_queue_maxqsize{job="rsyslog-impstats"} == 0'
              refId: A
              queryType: range
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              settings:
                mode: dropNN
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              conditions:
                - evaluator:
                    params:
                      - 0.8
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params: []
                  reducer:
                    params: []
                    type: avg
                  type: query
              expression: B
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Alerting
        for: 5m
        annotations:
          description: 'Queue {{ $labels.rsyslog_resource }} on {{ $labels.host }} is above 80% of max (ratio: {{ printf "%.2f" $values.B.Value }})'
          summary: 'Rsyslog queue depth high on {{ $labels.host }}'
        labels:
          alertname: Rsyslog queue depth high
          severity: warning
          component: rsyslog-impstats

      - uid: impstats-discarded-messages
        title: Rsyslog queue discarding messages
        isPaused: true
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'sum by (host, rsyslog_resource) (rate(rsyslog_core_queue_discarded_full_total{job="rsyslog-impstats"}[5m]) + rate(rsyslog_core_queue_discarded_nf_total{job="rsyslog-impstats"}[5m]))'
              refId: A
              queryType: range
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              settings:
                mode: dropNN
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              conditions:
                - evaluator:
                    params:
                      - 0
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params: []
                  reducer:
                    params: []
                    type: avg
                  type: query
              expression: B
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Alerting
        for: 2m
        annotations:
          description: 'Queue {{ $labels.rsyslog_resource }} on {{ $labels.host }} is discarding messages (rate: {{ printf "%.2f" $values.B.Value }}/s)'
          summary: 'Rsyslog discarding messages on {{ $labels.host }}'
        labels:
          alertname: Rsyslog queue discarding messages
          severity: warning
          component: rsyslog-impstats

      - uid: impstats-action-failures
        title: Rsyslog action failures
        isPaused: true
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'sum by (host, rsyslog_resource) (rate(rsyslog_core_action_failed_total{job="rsyslog-impstats"}[5m]))'
              refId: A
              queryType: range
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              settings:
                mode: dropNN
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              conditions:
                - evaluator:
                    params:
                      - 0
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params: []
                  reducer:
                    params: []
                    type: avg
                  type: query
              expression: B
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Alerting
        for: 2m
        annotations:
          description: 'Action {{ $labels.rsyslog_resource }} on {{ $labels.host }} is failing (rate: {{ printf "%.2f" $values.B.Value }}/s)'
          summary: 'Rsyslog action failures on {{ $labels.host }}'
        labels:
          alertname: Rsyslog action failures
          severity: warning
          component: rsyslog-impstats

      - uid: impstats-action-suspended
        title: Rsyslog action suspended
        isPaused: true
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: 'rsyslog_core_action_suspended{job="rsyslog-impstats"} == 1'
              refId: A
              queryType: range
              intervalMs: 1000
              maxDataPoints: 43200
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              settings:
                mode: dropNN
              refId: B
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                name: Expression
                type: __expr__
                uid: __expr__
              conditions:
                - evaluator:
                    params:
                      - 0
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params: []
                  reducer:
                    params: []
                    type: avg
                  type: query
              expression: B
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Alerting
        for: 2m
        annotations:
          description: 'Action {{ $labels.rsyslog_resource }} on {{ $labels.host }} is suspended'
          summary: 'Rsyslog action suspended on {{ $labels.host }}'
        labels:
          alertname: Rsyslog action suspended
          severity: warning
          component: rsyslog-impstats
