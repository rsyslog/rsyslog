# rsyslog -> Loki direct push via omhttp
# Sends logs directly to Loki without intermediate agents

module(load="omhttp")

# Template for Loki push API with proper labels
template(name="LokiJsonStream" type="list") {
    constant(value="{\"streams\":[{\"stream\":{")
    constant(value="\"job\":\"syslog\",")
    constant(value="\"host\":\"")
    property(name="hostname" format="json")
    constant(value="\",\"app\":\"")
    property(name="programname" format="json")
    constant(value="\",\"severity\":\"")
    property(name="syslogseverity-text")
    constant(value="\"")
    constant(value="},\"values\":[[\"")
    property(name="timereported" dateformat="unixtimestamp")
    constant(value="000000000\",\"")
    property(name="msg" format="json")
    constant(value="\"]]}]}")
}

# Loki push ruleset
ruleset(name="loki") {
    action(
        type="omhttp"
        name="loki-direct"
        server="loki"
        serverport="3100"
        usehttps="off"
        restpath="loki/api/v1/push"
        template="LokiJsonStream"
        httpcontenttype="application/json"
        batch="off"
        queue.type="LinkedList"
        queue.size="10000"
        queue.filename="loki-queue"
        queue.saveOnShutdown="on"
        queue.maxDiskSpace="100m"
        action.resumeRetryCount="-1"
        action.resumeInterval="5"
    )

    /var/log/debug;RSYSLOG_SyslogProtocol23Format
}
